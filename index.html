<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FPL Predictions</title>

  <style>
    body { font-family: Arial, sans-serif; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { padding: 10px; cursor: pointer; border: 1px solid #ccc; }
    .tab.active { background: #f2f2f2; font-weight: bold; }

    table { border-collapse: collapse; width: 100%; font-size: 12px; overflow-x: auto; display: block; }
    th, td { border: 1px solid #ccc; padding: 4px; white-space: nowrap; }
    th { cursor: pointer; background: #f9f9f9; }
    th.sorted-asc::after { content: " ↑"; }
    th.sorted-desc::after { content: " ↓"; }

    input { margin: 5px; padding: 5px; }
    #lastUpdated { margin: 10px 0; font-style: italic; color: #555; }

    .selected-row { background-color: #fff3cd !important; }
    .team-highlight { background-color: #d1ffd1 !important; }

    #results tr:nth-child(even):not(.selected-row):not(.team-highlight):not(.separator-row) {
      background-color: #f7f7f7;
    }

    .separator-row td {
      background: #ddd !important;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>FPL Predictions</h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('data_1w.json', this)">1 Week</div>
    <div class="tab" onclick="switchTab('data_3w.json', this)">3 Weeks</div>
    <div class="tab" onclick="switchTab('data_5w.json', this)">5 Weeks</div>
  </div>

  <!-- Team toggles -->
  <label><input type="checkbox" id="teamCBox"> Team C</label>
  <label><input type="checkbox" id="teamJBox"> Team J</label>

  <!-- Filters -->
  <input type="text"   id="nameFilter"     placeholder="Filter by player name">
  <input type="text"   id="teamFilter"     placeholder="Filter by team">
  <input type="text"   id="positionFilter" placeholder="Position (GK/DEF/MID/FWD)">
  <input type="number" id="minutesFilter"  placeholder="Min minutes">
  <input type="number" id="pointsFilter"   placeholder="Min points">

  <p id="lastUpdated"></p>

  <table>
    <thead id="table-head"></thead>
    <tbody id="results"></tbody>
  </table>

<script>
  let rawData = [];
  let filteredData = [];
  let columns = [];

  let currentSortColumn = null;
  let currentSortDirection = 1;

  let selectedPlayerId = null;

  let teamC = [];
  let teamJ = [];
  let activeTeam = null;

  const positionMap = { 1: "GK", 2: "DEF", 3: "MID", 4: "FWD" };

  function $(id) { return document.getElementById(id); }

  async function loadTeams() {
    const c = await fetch("C.json").then(r => r.json());
    const j = await fetch("J.json").then(r => r.json());
    teamC = c.records ?? c;
    teamJ = j.records ?? j;
  }
  loadTeams();

  async function loadData(file) {
    const response = await fetch(file);
    const json = await response.json();

    rawData = json.records ?? json;

    if (json.metadata?.last_updated) {
      $("lastUpdated").textContent = "Last updated: " + json.metadata.last_updated;
    }

    columns = Object.keys(rawData[0]).filter(c => c !== "player_id");

    if (columns.includes("points") && columns.includes("points_adj")) {
      columns = columns.filter(c => c !== "points_adj");
      const i = columns.indexOf("points");
      columns.splice(i + 1, 0, "points_adj");
    }

    applyFilters();
    applySort();
    renderHeader();
    renderTable();
  }

  function applyFilters() {
    const nameQ = $("nameFilter").value.toLowerCase();
    const teamQ = $("teamFilter").value.toLowerCase();
    const posQ  = $("positionFilter").value.toLowerCase();
    const minMinutes = parseInt($("minutesFilter").value) || 0;
    const minPoints  = parseFloat($("pointsFilter").value) || 0;

    filteredData = rawData.filter(item =>
      item.web_name.toLowerCase().includes(nameQ) &&
      item.team.toLowerCase().includes(teamQ) &&
      (positionMap[item.position] || "").toLowerCase().includes(posQ) &&
      item.minutes >= minMinutes &&
      item.points  >= minPoints
    );
  }

  ["nameFilter", "teamFilter", "positionFilter", "minutesFilter", "pointsFilter"]
    .forEach(id => {
      $(id).addEventListener("input", () => {
        applyFilters();
        applySort();
        renderTable();
      });
    });

  function sortTable(column) {
    if (currentSortColumn === column) {
      currentSortDirection *= -1;
    } else {
      currentSortColumn = column;
      currentSortDirection = 1;
    }
    applySort();
    renderHeader();
    renderTable();
  }

  function applySort() {
    if (!currentSortColumn) return;

    const sorter = (a, b) => {
      const A = a[currentSortColumn];
      const B = b[currentSortColumn];
      if (typeof A === "number" && typeof B === "number") return (A - B) * currentSortDirection;
      if (A === B) return 0;
      return (A > B ? 1 : -1) * currentSortDirection;
    };

    filteredData.sort(sorter);
  }

  function renderHeader() {
    $("table-head").innerHTML =
      `<tr>${columns.map(c => {
        let cls = "";
        if (c === currentSortColumn) cls = currentSortDirection === 1 ? "sorted-asc" : "sorted-desc";
        return `<th class="${cls}" onclick="sortTable('${c}')">${c}</th>`;
      }).join("")}</tr>`;
  }

  function renderTable() {
    let html = "";

    if (activeTeam) {
      const teamList = activeTeam === "C" ? teamC : teamJ;
      const ids = new Set(teamList.map(p => p.player_id));

      let teamRows = rawData.filter(p => ids.has(p.player_id));

      if (currentSortColumn) {
        teamRows.sort((a, b) => {
          const A = a[currentSortColumn];
          const B = b[currentSortColumn];
          if (typeof A === "number" && typeof B === "number") return (A - B) * currentSortDirection;
          if (A === B) return 0;
          return (A > B ? 1 : -1) * currentSortDirection;
        });
      }

      html += teamRows.map(row => `
        <tr class="team-highlight">
          ${columns.map(c => {
            let val = row[c];
            if (c === "position") val = positionMap[val] || val;
            else if (c === "minutes") val = Math.round(val);
            else if (typeof val === "number") val = val.toFixed(2);
            return `<td>${val}</td>`;
          }).join("")}
        </tr>
      `).join("");

      html += `<tr class="separator-row"><td colspan="${columns.length}">— End of Team ${activeTeam} —</td></tr>`;
    }

    html += filteredData.map((row, idx) => `
      <tr onclick="highlightRow(${idx})">
        ${columns.map(c => {
          let val = row[c];
          if (c === "position") val = positionMap[val] || val;
          else if (c === "minutes") val = Math.round(val);
          else if (typeof val === "number") val = val.toFixed(2);
          return `<td>${val}</td>`;
        }).join("")}
      </tr>
    `).join("");

    $("results").innerHTML = html;

    applyHighlight();
    applyTeamHighlight();
  }

  function highlightRow(index) {
    const row = filteredData[index];
    if (!row) return;
    selectedPlayerId = row.player_id;
    applyHighlight();
  }

  function applyHighlight() {
    const rows = document.querySelectorAll("#results tr");
    rows.forEach(r => r.classList.remove("selected-row"));

    if (selectedPlayerId === null) return;

    const index = filteredData.findIndex(r => r.player_id === selectedPlayerId);

    let offset = 0;
    if (activeTeam) {
      const teamList = activeTeam === "C" ? teamC : teamJ;
      offset = teamList.length + 1;
    }

    const rowEl = rows[index + offset];
    if (rowEl) rowEl.classList.add("selected-row");
  }

  // ⭐ FIXED: Highlight team players in BOTH sections
  function applyTeamHighlight() {
    const rows = document.querySelectorAll("#results tr");
    rows.forEach(r => r.classList.remove("team-highlight"));

    if (!activeTeam) return;

    const teamList = activeTeam === "C" ? teamC : teamJ;
    const ids = new Set(teamList.map(p => p.player_id));

    let offset = teamList.length + 1;

    // Highlight team rows at the top
    for (let i = 0; i < teamList.length; i++) {
      rows[i].classList.add("team-highlight");
    }

    // Highlight matching players in the main list
    filteredData.forEach((row, i) => {
      if (ids.has(row.player_id)) {
        rows[i + offset].classList.add("team-highlight");
      }
    });
  }

  $("teamCBox").addEventListener("change", () => {
    if ($("teamCBox").checked) {
      $("teamJBox").checked = false;
      activeTeam = "C";
    } else activeTeam = null;
    renderTable();
  });

  $("teamJBox").addEventListener("change", () => {
    if ($("teamJBox").checked) {
      $("teamCBox").checked = false;
      activeTeam = "J";
    } else activeTeam = null;
    renderTable();
  });

  async function switchTab(file, el) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");
    await loadData(file);
  }

  loadData("data_1w.json");
</script>
</body>
</html>
