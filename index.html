<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FPL Predictions</title>

  <style>
    body { font-family: Arial, sans-serif; }
    .tabs { display: flex; margin-bottom: 10px; gap: 10px; flex-wrap: wrap; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; overflow-x: auto; display: block; }
    th, td { border: 1px solid #ccc; padding: 4px; white-space: nowrap; }
    th { cursor: pointer; background: #f9f9f9; }
    th.sorted-asc::after { content: " ↑"; }
    th.sorted-desc::after { content: " ↓"; }

    input { margin: 5px; padding: 5px; }
    #lastUpdated { margin: 10px 0; font-style: italic; color: #555; }

    .selected-row { background-color: #fff3cd !important; }
    .team-highlight { background-color: #d1ffd1 !important; }

    #results tr:nth-child(even):not(.selected-row):not(.team-highlight):not(.separator-row) {
      background-color: #f7f7f7;
    }

    .separator-row td {
      background: #ddd !important;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>FPL Predictions</h1>

  <!-- GW CHECKBOXES -->
  <div id="gwSelector" class="tabs"></div>

  <!-- Team toggles -->
  <div id="teamRow">
    <label><input type="checkbox" id="teamCBox"> Team C</label>
    <label><input type="checkbox" id="teamJBox"> Team J</label>
  </div>

  <!-- Filters -->
  <div id="playerRow">
    <input type="text" id="nameFilter" placeholder="Filter by player name">
    <input type="text" id="teamFilter" placeholder="Filter by team">
  </div>
  <div id="posRow">
    <input type="text" id="positionFilter" placeholder="Position (GK/DEF/MID/FWD)">
    <input type="number" id="minutesFilter" placeholder="Min minutes">
  </div>
  <div id="pointsRow">
    <input type="number" id="pointsFilter" placeholder="Min points">
    <input type="number" id="pointsAdjFilter" placeholder="Min adj points">
  </div>

  <p id="lastUpdated"></p>

  <table>
    <thead id="table-head"></thead>
    <tbody id="results"></tbody>
  </table>

<script>
  let rawData = [];
  let filteredData = [];
  let columns = [];

  let currentSortColumn = null;
  let currentSortDirection = 1;

  let selectedPlayerId = null;

  let teamC = [];
  let teamJ = [];
  let activeTeam = null;   // ⭐ START WITH NO TEAM SELECTED

  const positionMap = { 1: "GK", 2: "DEF", 3: "MID", 4: "FWD" };

  const protectedFields = new Set([
    "player_id",
    "web_name",
    "team",
    "position",
    "minutes",
    "cost"
  ]);

  function $(id) { return document.getElementById(id); }

  async function loadTeams() {
    const c = await fetch("C.json").then(r => r.json());
    const j = await fetch("J.json").then(r => r.json());
    teamC = (c.records ?? c).map(p => ({ ...p, player_id: parseInt(p.player_id) }));
    teamJ = (j.records ?? j).map(p => ({ ...p, player_id: parseInt(p.player_id) }));
  }
  loadTeams();

  function gwFile(gw) { return `gw${gw}.json`; }

  // Load GW checkboxes
  async function loadGWCheckboxes() {
    const gwData = await fetch("gws.json").then(r => r.json());
    const gws = gwData.gameweeks.sort((a, b) => a - b);

    const container = $("gwSelector");
    container.innerHTML = "";

    gws.forEach(gw => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" class="gwBox" value="${gw}"> GW${gw}`;
      container.appendChild(label);
    });

    document.querySelectorAll(".gwBox").forEach(box =>
      box.addEventListener("change", loadSelectedGWs)
    );
  }

  loadGWCheckboxes();

  // ⭐ ENSURE NO TEAM IS SELECTED AT STARTUP
  window.addEventListener("DOMContentLoaded", () => {
    $("teamCBox").checked = false;
    $("teamJBox").checked = false;
    activeTeam = null;
  });

  // Load + merge selected GWs
  async function loadSelectedGWs() {
    const selected = [...document.querySelectorAll(".gwBox:checked")]
      .map(b => parseInt(b.value))
      .sort((a, b) => a - b);

    if (selected.length === 0) {
      rawData = [];
      filteredData = [];
      columns = [];
      $("table-head").innerHTML = "";
      $("results").innerHTML = "";
      $("lastUpdated").textContent = "";
      selectedPlayerId = null;
      return;
    }

    const datasets = await Promise.all(
      selected.map(gw => fetch(gwFile(gw)).then(r => r.json()))
    );

    const records = datasets.map(d => d.records ?? d);

    // last_updated from lowest GW
    const firstMeta = datasets[0].metadata;
    $("lastUpdated").textContent = firstMeta?.last_updated
      ? "Last updated: " + firstMeta.last_updated
      : "";

    const merged = {};

    for (const weekData of records) {
      for (const p of weekData) {
        const pid = parseInt(p.player_id);

        if (!merged[pid]) {
          merged[pid] = {
            ...p,
            player_id: pid,
            __gwCount: 1,
            __pointsAdjSum: typeof p.points_adj === "number" ? p.points_adj : 0
          };
        } else {
          const target = merged[pid];
          target.__gwCount++;

          for (const key of Object.keys(p)) {
            const val = p[key];

            if (key === "points_adj" && typeof val === "number") {
              target.__pointsAdjSum += val;
              continue;
            }

            if (protectedFields.has(key)) continue;

            if (typeof val === "number") {
              if (typeof target[key] !== "number") target[key] = 0;
              target[key] += val;
            }
          }
        }
      }
    }

    rawData = Object.values(merged).map(p => {
      p.points_adj = p.__pointsAdjSum / p.__gwCount;
      delete p.__gwCount;
      delete p.__pointsAdjSum;
      return p;
    });

    if (rawData.length > 0) {
      columns = Object.keys(rawData[0]).filter(c => c !== "player_id");

      const desiredOrder = [
        "web_name", "team", "position",
        "points", "points_adj", "minutes", "cost"
      ];

      columns = [
        ...desiredOrder.filter(c => columns.includes(c)),
        ...columns.filter(c => !desiredOrder.includes(c))
      ];
    }

    applyFilters();

    if (selectedPlayerId !== null) {
      const exists = filteredData.some(p => p.player_id === selectedPlayerId);
      if (!exists) selectedPlayerId = null;
    }

    applySort();
    renderHeader();
    renderTable();
  }

  // Filters
  function applyFilters() {
    const nameQ = $("nameFilter").value.toLowerCase();
    const teamQ = $("teamFilter").value.toLowerCase();
    const posQ  = $("positionFilter").value.toLowerCase();
    const minMinutes = parseInt($("minutesFilter").value) || 0;
    const minPoints  = parseFloat($("pointsFilter").value) || 0;
    const minAdjPoints = parseFloat($("pointsAdjFilter").value) || 0;

    filteredData = rawData.filter(item =>
      item.web_name.toLowerCase().includes(nameQ) &&
      item.team.toLowerCase().includes(teamQ) &&
      (positionMap[item.position] || "").toLowerCase().includes(posQ) &&
      item.minutes >= minMinutes &&
      item.points  >= minPoints &&
      item.points_adj >= minAdjPoints
    );
  }

  ["nameFilter", "teamFilter", "positionFilter", "minutesFilter", "pointsFilter", "pointsAdjFilter"]
    .forEach(id => {
      $(id).addEventListener("input", () => {
        applyFilters();

        if (selectedPlayerId !== null) {
          const exists = filteredData.some(p => p.player_id === selectedPlayerId);
          if (!exists) selectedPlayerId = null;
        }

        applySort();
        renderTable();
      });
    });

  // Sorting
  function sortTable(column) {
    if (currentSortColumn === column) {
      currentSortDirection *= -1;
    } else {
      currentSortColumn = column;
      currentSortDirection = 1;
    }
    applySort();
    renderHeader();
    renderTable();
  }

  function applySort() {
    if (!currentSortColumn) return;

    filteredData.sort((a, b) => {
      const A = a[currentSortColumn];
      const B = b[currentSortColumn];
      if (typeof A === "number" && typeof B === "number") return (A - B) * currentSortDirection;
      if (A === B) return 0;
      return (A > B ? 1 : -1) * currentSortDirection;
    });
  }

  function renderHeader() {
    if (!columns.length) {
      $("table-head").innerHTML = "";
      return;
    }

    $("table-head").innerHTML =
      `<tr>${columns.map(c => {
        let cls = "";
        if (c === currentSortColumn) cls = currentSortDirection === 1 ? "sorted-asc" : "sorted-desc";
        return `<th class="${cls}" onclick="sortTable('${c}')">${c}</th>`;
      }).join("")}</tr>`;
  }

  // Table rendering
  function renderTable() {
    let html = "";

    // TEAM BLOCK AT TOP
    if (activeTeam) {
      const teamList = activeTeam === "C" ? teamC : teamJ;
      const ids = new Set(teamList.map(p => p.player_id));

      const teamRows = filteredData.filter(p => ids.has(p.player_id));

      html += teamRows.map(row => rowToHTML(row, true)).join("");
      html += `<tr class="separator-row"><td colspan="${columns.length}">— End of Team ${activeTeam} —</td></tr>`;
    }

    // MAIN LIST (team players should ALSO appear here)
    const mainRows = filteredData;

    html += mainRows.map(row => rowToHTML(row, false)).join("");


    $("results").innerHTML = html;

    applyHighlight();
    applyTeamHighlight();
  }

  function rowToHTML(row, isTeamRow) {
    return `
      <tr data-player-id="${row.player_id}"
          class="${isTeamRow ? "team-highlight" : ""}"
          onclick="highlightRowById(${row.player_id})">
        ${columns.map(c => {
          let val = row[c];
          if (c === "position") val = positionMap[val] || val;
          else if (c === "minutes") val = Math.round(val);
          else if (typeof val === "number") val = val.toFixed(2);
          return `<td>${val}</td>`;
        }).join("")}
      </tr>
    `;
  }

  // Highlighting
  function highlightRowById(pid) {
    selectedPlayerId = pid;
    applyHighlight();
  }

  function applyHighlight() {
    const rows = document.querySelectorAll("#results tr");
    rows.forEach(r => r.classList.remove("selected-row"));

    if (!selectedPlayerId) return;

    const row = [...rows].find(r => parseInt(r.dataset.playerId) === selectedPlayerId);
    if (row) row.classList.add("selected-row");
  }

  function applyTeamHighlight() {
    const rows = document.querySelectorAll("#results tr");
    rows.forEach(r => r.classList.remove("team-highlight"));

    if (!activeTeam) return;

    const teamList = activeTeam === "C" ? teamC : teamJ;
    const ids = new Set(teamList.map(p => p.player_id));

    rows.forEach(row => {
      const pid = parseInt(row.dataset.playerId);
      if (ids.has(pid)) row.classList.add("team-highlight");
    });
  }

  // Team toggles
  $("teamCBox").addEventListener("change", () => {
    if ($("teamCBox").checked) {
      $("teamJBox").checked = false;
      activeTeam = "C";
    } else activeTeam = null;
    renderTable();
  });

  $("teamJBox").addEventListener("change", () => {
    if ($("teamJBox").checked) {
      $("teamCBox").checked = false;
      activeTeam = "J";
    } else activeTeam = null;
    renderTable();
  });
</script>
</body>
</html>
