<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FPL Predictions</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { padding: 10px; cursor: pointer; border: 1px solid #ccc; }
    .tab.active { background: #f2f2f2; font-weight: bold; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; overflow-x: auto; display: block; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: left; white-space: nowrap; }
    th { cursor: pointer; background: #f9f9f9; }
    th.sorted-asc::after { content: " ↑"; }
    th.sorted-desc::after { content: " ↓"; }
    input { margin: 5px; padding: 5px; }
    #lastUpdated { margin: 10px 0; font-style: italic; color: #555; }

    .selected-row {
      background-color: #fff3cd !important;
    }

    #results tr:nth-child(even):not(.selected-row) {
      background-color: #f7f7f7;
    }
  </style>
</head>
<body>
  <h1>FPL Predictions</h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('data_1w.json', this)">1 Week</div>
    <div class="tab" onclick="switchTab('data_3w.json', this)">3 Weeks</div>
    <div class="tab" onclick="switchTab('data_5w.json', this)">5 Weeks</div>
  </div>

  <input type="text" id="nameFilter" placeholder="Filter by player name">
  <input type="text" id="teamFilter" placeholder="Filter by team">
  <input type="text" id="positionFilter" placeholder="Filter by position (GK/DEF/MID/FWD)">
  <input type="number" id="minutesFilter" placeholder="Min minutes played">

  <p id="lastUpdated"></p>

  <table id="fpl-table">
    <thead id="table-head"></thead>
    <tbody id="results"></tbody>
  </table>

  <script>
    let data = [];
    let filteredData = [];
    let columns = [];
    let currentSortColumn = null;
    let currentSortDirection = 1; // 1 = asc, -1 = desc

    const positionMap = { 1: "GK", 2: "DEF", 3: "MID", 4: "FWD" };

    async function loadData(file) {
      const response = await fetch(file);
      const json = await response.json();

      if (json.metadata && json.metadata.last_updated) {
        document.getElementById("lastUpdated").textContent =
          "Last updated: " + new Date(json.metadata.last_updated).toLocaleString();
        data = json.records;
      } else {
        data = json;
        document.getElementById("lastUpdated").textContent =
          "Last updated: " + new Date().toLocaleString();
      }

      // Build column list, remove m4 + blank, reorder points_adj
      let cols = Object.keys(data[0]).filter(c => c !== "m4" && c.trim() !== "");

      if (cols.includes("points") && cols.includes("points_adj")) {
        cols = cols.filter(c => c !== "points_adj");
        const pointsIndex = cols.indexOf("points");
        cols.splice(pointsIndex + 1, 0, "points_adj");
      }

      columns = cols;

      filteredData = [...data];
      renderHeader();
      renderTable(filteredData);
    }

    function renderHeader() {
      document.getElementById('table-head').innerHTML =
        `<tr>${columns.map(c => {
          let cls = "";
          if (c === currentSortColumn) {
            cls = currentSortDirection === 1 ? "sorted-asc" : "sorted-desc";
          }
          return `<th class="${cls}" onclick="sortTable('${c}')">${c}</th>`;
        }).join('')}</tr>`;
    }

    function renderTable(rows) {
      document.getElementById('results').innerHTML =
        rows.map((r, idx) =>
          `<tr data-index="${idx}" onclick="highlightRow(${idx})">
            ${columns.map(c => {
              let val = r[c];
              if (c === "position") {
                val = positionMap[val] || val;
              } else if (c === "minutes") {
                val = Math.round(val);
              } else if (typeof val === 'number') {
                val = Number(val).toFixed(2);
              }
              return `<td>${val}</td>`;
            }).join('')}
          </tr>`
        ).join('');
    }

    function applyFilters() {
      const nameQ = document.getElementById('nameFilter').value.toLowerCase();
      const teamQ = document.getElementById('teamFilter').value.toLowerCase();
      const posQ = document.getElementById('positionFilter').value.toLowerCase();
      const minMinutes = parseInt(document.getElementById('minutesFilter').value) || 0;

      filteredData = data.filter(item =>
        item.web_name.toLowerCase().includes(nameQ) &&
        item.team.toLowerCase().includes(teamQ) &&
        String(positionMap[item.position] || item.position).toLowerCase().includes(posQ) &&
        item.minutes >= minMinutes
      );
      renderTable(filteredData);
    }

    document.getElementById('nameFilter').addEventListener('input', applyFilters);
    document.getElementById('teamFilter').addEventListener('input', applyFilters);
    document.getElementById('positionFilter').addEventListener('input', applyFilters);
    document.getElementById('minutesFilter').addEventListener('input', applyFilters);

    function sortTable(column) {
      if (currentSortColumn === column) {
        currentSortDirection *= -1; // flip
      } else {
        currentSortColumn = column;
        currentSortDirection = 1; // new column → ascending
      }

      filteredData.sort((a, b) => {
        const valA = a[column];
        const valB = b[column];

        if (typeof valA === 'number' && typeof valB === 'number') {
          return (valA - valB) * currentSortDirection;
        }
        if (valA === valB) return 0;
        return (valA > valB ? 1 : -1) * currentSortDirection;
      });

      renderHeader();
      renderTable(filteredData);
    }

    async function switchTab(file, el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      await loadData(file);
      applyFilters();

      // Optional: reset sort when switching tabs
      currentSortColumn = null;
      currentSortDirection = 1;
      renderHeader();
    }

    function highlightRow(index) {
      const table = document.getElementById('results');
      const rows = table.getElementsByTagName('tr');

      for (let r of rows) {
        r.classList.remove('selected-row');
      }

      const selected = rows[index];
      if (selected) {
        selected.classList.add('selected-row');
      }
    }

    loadData('data_1w.json');
  </script>
</body>
</html>
