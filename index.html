<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FPL Predictions</title>

  <style>
    body { font-family: Arial, sans-serif; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { padding: 10px; cursor: pointer; border: 1px solid #ccc; }
    .tab.active { background: #f2f2f2; font-weight: bold; }

    table { border-collapse: collapse; width: 100%; font-size: 12px; overflow-x: auto; display: block; }
    th, td { border: 1px solid #ccc; padding: 4px; white-space: nowrap; }
    th { cursor: pointer; background: #f9f9f9; }
    th.sorted-asc::after { content: " ↑"; }
    th.sorted-desc::after { content: " ↓"; }

    input { margin: 5px; padding: 5px; }
    #lastUpdated { margin: 10px 0; font-style: italic; color: #555; }

    .selected-row { background-color: #fff3cd !important; }
    .team-highlight { background-color: #d1ffd1 !important; }

    #results tr:nth-child(even):not(.selected-row):not(.team-highlight) {
      background-color: #f7f7f7;
    }

    /* Team table styling similar to main table */
    #teamTable {
      display: none;
      width: 100%;
      margin-bottom: 15px;
    }

    #teamTable tr:nth-child(even) {
      background-color: #f7fff7;
    }
  </style>
</head>

<body>
  <h1>FPL Predictions</h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('data_1w.json', this)">1 Week</div>
    <div class="tab" onclick="switchTab('data_3w.json', this)">3 Weeks</div>
    <div class="tab" onclick="switchTab('data_5w.json', this)">5 Weeks</div>
  </div>

  <!-- Team toggles -->
  <label><input type="checkbox" id="teamCBox"> Team C</label>
  <label><input type="checkbox" id="teamJBox"> Team J</label>

  <!-- Filters -->
  <input type="text"   id="nameFilter"     placeholder="Filter by player name">
  <input type="text"   id="teamFilter"     placeholder="Filter by team">
  <input type="text"   id="positionFilter" placeholder="Position (GK/DEF/MID/FWD)">
  <input type="number" id="minutesFilter"  placeholder="Min minutes">
  <input type="number" id="pointsFilter"   placeholder="Min points">

  <p id="lastUpdated"></p>

  <!-- TEAM TABLE (full team, not filtered, independently sortable) -->
  <h2 id="teamTitle" style="display:none;">Selected Team</h2>
  <table id="teamTable">
    <thead id="team-head"></thead>
    <tbody id="team-body"></tbody>
  </table>

  <!-- MAIN TABLE -->
  <table>
    <thead id="table-head"></thead>
    <tbody id="results"></tbody>
  </table>

<script>
  // ------------------------------
  // STATE
  // ------------------------------
  let rawData = [];
  let filteredData = [];
  let columns = [];

  let currentSortColumn = null;
  let currentSortDirection = 1;

  // Separate sorting for team table
  let teamSortColumn = null;
  let teamSortDirection = 1;

  let selectedPlayerId = null;

  let teamC = [];
  let teamJ = [];
  let activeTeam = null;

  const positionMap = { 1: "GK", 2: "DEF", 3: "MID", 4: "FWD" };


  // ------------------------------
  // HELPERS
  // ------------------------------
  function $(id) { return document.getElementById(id); }


  // ------------------------------
  // LOAD TEAM FILES (C & J)
  // ------------------------------
  async function loadTeams() {
    const c = await fetch("C.json").then(r => r.json());
    const j = await fetch("J.json").then(r => r.json());

    teamC = c.records ?? c;
    teamJ = j.records ?? j;
  }

  loadTeams();


  // ------------------------------
  // LOAD MAIN DATA
  // ------------------------------
  async function loadData(file) {
    const response = await fetch(file);
    const json = await response.json();

    rawData = json.records ?? json;

    // Use metadata timestamp
    if (json.metadata?.last_updated) {
      $("lastUpdated").textContent = "Last updated: " + json.metadata.last_updated;
    }

    // Build column list (no player_id)
    columns = Object.keys(rawData[0]).filter(c => c !== "player_id");

    // Move points_adj next to points
    if (columns.includes("points") && columns.includes("points_adj")) {
      columns = columns.filter(c => c !== "points_adj");
      const i = columns.indexOf("points");
      columns.splice(i + 1, 0, "points_adj");
    }

    applyFilters();
    applySort();
    renderHeader();
    renderTable();
    renderTeamTable(); // keep team table in sync on data load/tab switch
  }


  // ------------------------------
  // FILTERING (MAIN TABLE ONLY)
  // ------------------------------
  function applyFilters() {
    const nameQ = $("nameFilter").value.toLowerCase();
    const teamQ = $("teamFilter").value.toLowerCase();
    const posQ  = $("positionFilter").value.toLowerCase();
    const minMinutes = parseInt($("minutesFilter").value) || 0;
    const minPoints  = parseFloat($("pointsFilter").value) || 0;

    filteredData = rawData.filter(item =>
      item.web_name.toLowerCase().includes(nameQ) &&
      item.team.toLowerCase().includes(teamQ) &&
      (positionMap[item.position] || "").toLowerCase().includes(posQ) &&
      item.minutes >= minMinutes &&
      item.points  >= minPoints
    );
  }

  ["nameFilter", "teamFilter", "positionFilter", "minutesFilter", "pointsFilter"]
    .forEach(id => {
      $(id).addEventListener("input", () => {
        applyFilters();
        applySort();
        renderTable();
        // team table uses its own sorting and rawData; no need to change here
      });
    });


  // ------------------------------
  // SORTING MAIN TABLE
  // ------------------------------
  function sortTable(column) {
    if (currentSortColumn === column) {
      currentSortDirection *= -1;
    } else {
      currentSortColumn = column;
      currentSortDirection = 1;
    }

    applySort();
    renderHeader();
    renderTable();
  }

  function applySort() {
    if (!currentSortColumn) return;

    filteredData.sort((a, b) => {
      const A = a[currentSortColumn];
      const B = b[currentSortColumn];

      if (typeof A === "number" && typeof B === "number") {
        return (A - B) * currentSortDirection;
      }
      if (A === B) return 0;
      return (A > B ? 1 : -1) * currentSortDirection;
    });
  }


  // ------------------------------
  // RENDERING MAIN TABLE
  // ------------------------------
  function renderHeader() {
    $("table-head").innerHTML =
      `<tr>${columns.map(c => {
        let cls = "";
        if (c === currentSortColumn) {
          cls = currentSortDirection === 1 ? "sorted-asc" : "sorted-desc";
        }
        return `<th class="${cls}" onclick="sortTable('${c}')">${c}</th>`;
      }).join("")}</tr>`;
  }

  function renderTable() {
    $("results").innerHTML =
      filteredData.map((row, idx) => `
        <tr onclick="highlightRow(${idx})">
          ${columns.map(c => {
            let val = row[c];
            if (c === "position") val = positionMap[val] || val;
            else if (c === "minutes") val = Math.round(val);
            else if (typeof val === "number") val = val.toFixed(2);
            return `<td>${val}</td>`;
          }).join("")}
        </tr>
      `).join("");

    applyHighlight();
    applyTeamHighlight();
  }


  // ------------------------------
  // MANUAL HIGHLIGHT
  // ------------------------------
  function highlightRow(index) {
    const row = filteredData[index];
    if (!row) return;

    selectedPlayerId = row.player_id;
    applyHighlight();
  }

  function applyHighlight() {
    const rows = document.querySelectorAll("#results tr");
    rows.forEach(r => r.classList.remove("selected-row"));

    if (selectedPlayerId === null) return;

    const index = filteredData.findIndex(r => r.player_id === selectedPlayerId);
    if (index !== -1 && rows[index]) {
      rows[index].classList.add("selected-row");
    }
  }


  // ------------------------------
  // TEAM HIGHLIGHTING (C / J) IN MAIN TABLE
  // ------------------------------
  function applyTeamHighlight() {
    const rows = document.querySelectorAll("#results tr");
    rows.forEach(r => r.classList.remove("team-highlight"));

    if (!activeTeam) return;

    const teamList = activeTeam === "C" ? teamC : teamJ;
    const ids = new Set(teamList.map(p => p.player_id));

    filteredData.forEach((row, i) => {
      if (ids.has(row.player_id)) {
        rows[i].classList.add("team-highlight");
      }
    });
  }

  $("teamCBox").addEventListener("change", () => {
    if ($("teamCBox").checked) {
      $("teamJBox").checked = false;
      activeTeam = "C";
    } else {
      activeTeam = null;
    }
    applyTeamHighlight();
    renderTeamTable(); // show/hide/update team table
  });

  $("teamJBox").addEventListener("change", () => {
    if ($("teamJBox").checked) {
      $("teamCBox").checked = false;
      activeTeam = "J";
    } else {
      activeTeam = null;
    }
    applyTeamHighlight();
    renderTeamTable(); // show/hide/update team table
  });


  // ------------------------------
  // TEAM TABLE (FULL TEAM, OWN SORTING)
  // ------------------------------
  function renderTeamTable() {
    const teamTitle = $("teamTitle");
    const teamTable = $("teamTable");

    if (!activeTeam) {
      teamTitle.style.display = "none";
      teamTable.style.display = "none";
      $("team-head").innerHTML = "";
      $("team-body").innerHTML = "";
      return;
    }

    const teamList = activeTeam === "C" ? teamC : teamJ;
    const ids = new Set(teamList.map(p => p.player_id));

    // Use rawData so the team table is NOT filtered
    let teamData = rawData.filter(p => ids.has(p.player_id));

    // Apply team-specific sort (independent of main table)
    if (teamSortColumn) {
      teamData.sort((a, b) => {
        const A = a[teamSortColumn];
        const B = b[teamSortColumn];

        if (typeof A === "number" && typeof B === "number") {
          return (A - B) * teamSortDirection;
        }
        if (A === B) return 0;
        return (A > B ? 1 : -1) * teamSortDirection;
      });
    }

    // Show title + table
    teamTitle.textContent = `Team ${activeTeam}`;
    teamTitle.style.display = "block";
    teamTable.style.display = "block";

    // Header (clickable, independent sort)
    $("team-head").innerHTML =
      `<tr>${columns.map(c => {
        let cls = "";
        if (c === teamSortColumn) {
          cls = teamSortDirection === 1 ? "sorted-asc" : "sorted-desc";
        }
        return `<th class="${cls}" onclick="sortTeamTable('${c}')">${c}</th>`;
      }).join("")}</tr>`;

    // Body
    $("team-body").innerHTML =
      teamData.map(row => `
        <tr class="team-highlight">
          ${columns.map(c => {
            let val = row[c];
            if (c === "position") val = positionMap[val] || val;
            else if (c === "minutes") val = Math.round(val);
            else if (typeof val === "number") val = val.toFixed(2);
            return `<td>${val}</td>`;
          }).join("")}
        </tr>
      `).join("");
  }

  function sortTeamTable(column) {
    if (teamSortColumn === column) {
      teamSortDirection *= -1;
    } else {
      teamSortColumn = column;
      teamSortDirection = 1;
    }

    renderTeamTable();
  }


  // ------------------------------
  // TAB SWITCHING
  // ------------------------------
  async function switchTab(file, el) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");

    await loadData(file);
    renderTeamTable(); // keep team table synced on tab change
  }


  // ------------------------------
  // INIT
  // ------------------------------
  loadData("data_1w.json");
</script>
</body>
</html>
